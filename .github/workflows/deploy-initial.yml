name: Initial Full Deployment to EC2

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•´ ì‚¬ìš©

jobs:
  initial-deploy:
    runs-on: ubuntu-latest

    env:
      JAR_DIRS: |
        CARING-Back-Gateway
        CARING-Back-Manager
        CARING-Back-User
        CARING-Back-Config
        CARING-Back-Discovery

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build All JARs (Skip Tests)
        run: |
          for dir in $JAR_DIRS; do
            echo "ğŸ“¦ Building $dir"
            cd $dir
            chmod +x gradlew  # âœ… ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            ./gradlew bootJar -x test
            cd ..
          done

      - name: Upload files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "."
          target: "~/CARING_BACK"
          rm: false

      - name: SSH into EC2 and deploy ALL Compose (infra â†’ outer â†’ inner)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd ~/CARING_BACK

            if [ ! -f .env ]; then
              echo "âŒ .env íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            fi

            echo "ğŸ§± Deploying infra..."
            docker-compose -f docker-compose-infra.yml down
            sleep 2
            docker-compose -f docker-compose-infra.yml up -d --build
            sleep 60

            echo "ğŸšª Deploying outer..."
            docker-compose -f docker-compose-outer-app.yml down
            sleep 2
            docker-compose -f docker-compose-outer-app.yml up -d --build
            sleep 60

            echo "ğŸ§© Deploying inner..."
            docker-compose -f docker-compose-inner-app.yml down
            sleep 2
            docker-compose -f docker-compose-inner-app.yml up -d --build
